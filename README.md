# CityGML Mask Extraction

A lightweight Python tool to extract 2D binary mask images of building façades (with window/door openings) from a CityGML file.

## Environment Setup

We use a conda environment, run:

```bash
conda env create -f environment.yml
```

```bash
conda activate lod3-mask-extraction
```
## Running the Script

To run the tool, first place your CityGML file in the `data` folder, then execute a command similar to:
```bash
python run_extract.py --input data/DEBY_LOD3_4959323.gml --output example_output/
```



**Example Output GT Masks** 

<div align="center">

<table>
  <tr>
    <td align="center">
      <img src="example_output/4906972/mask_DEBY_LOD2_4906972_c4547f98-389d-4617-a5ef-405fbc939e8f_window.png" alt="Image 1" width="200px"><br>
      4906972
    </td>
    <td align="center">
      <img src="example_output/4959323/mask_DEBY_LOD2_4959323_5150f87d-bb94-4ffe-bdac-c5d180e863d5_window.png" alt="Image 2" width="200px"><br>
      4959323
    </td>
    <td align="center">
      <img src="example_output/4907507/mask_DEBY_LOD2_4907507_8ee10064-1c61-4081-948f-ca2915a1d26a_window.png" alt="Image 3" width="200px"><br>
      4907507(windows)
    </td>
    <td align="center">
      <img src="example_output/4959322/mask_DEBY_LOD2_4959322_9ceccd44-fdd9-48a2-8dfe-8637aa87a9ab_window.png" alt="Image 4" width="200px"><br>
      4959322
    </td>
  </tr>
  <tr>
    <td align="center">
      <img src="example_output/4907514/mask_DEBY_LOD2_4907514_9f0fe318-e654-43c1-873c-19793b0b3233_window.png" alt="Image 5" width="200px"><br>
      4907514
    </td>
    <td align="center">
      <img src="example_output/4907516/mask_DEBY_LOD2_4907516_1f1f95ff-cd9e-44b4-8a72-ea9ed4d0b405_window.png" alt="Image 6" width="200px"><br>
      4907516
    </td>
    <td align="center">
      <img src="example_output/4907520/mask_DEBY_LOD2_4907520_ea7be6c7-c269-489e-b51d-4153cb0c5e49_door.png" alt="Image 7" width="200px"><br>
      4907520(door)
    </td>
    <td align="center">
      <img src="example_output/4906970/mask_DEBY_LOD2_4906970_c368b4d3-0164-4919-b93a-65c11c4df672_window.png" alt="Image 8" width="200px"><br>
      4906970
    </td>
  </tr>
</table>

</div>

## Controlling Mask Type Generation

The types of masks generated by the tool are controlled by the `MASK_TYPE` parameter in the `utils.py` file. You can change its value to control which masks are produced:

- **`"all"`**:  
  Generate all mask types, including the full façade mask (with both door and window overlays) as well as separate door and window masks.

- **`"full"`**:  
  Only generate a full mask image that combines both door and window overlays on the façade.

- **`"door"`**:  
  Generate only a mask for door openings.

- **`"window"`**:  
  Generate only a mask for window openings.

For example, to generate only door masks, modify the parameter in `utils.py` as follows:
```python
MASK_TYPE = "door"
```



## Core Method

The tool processes the CityGML file in the following steps:

1. **GML Parsing:**  
   - Extract exterior and interior polygon coordinates from each `<bldg:WallSurface>` element.
   - Identify openings (windows/doors) by parsing both the interior rings and specific `<bldg:opening>`, `<bldg:Door>`, and `<bldg:Window>` elements.

2. **PCA Projection:**  
   - Compute the normal vector of the façade using the first extracted polygon.
   - Define 2D projection axes from the normal via a PCA-inspired approach to project 3D points onto a 2D plane.

3. **Shapely Processing:**  
   - Convert the projected points into 2D polygon shapes.
   - Merge multiple façade polygons into a unified shape.
   - Group and subtract the window and door openings from the façade polygon to generate holes.

4. **Rasterization:**  
   - Render the final 2D polygons as binary mask images (white for the openings and black for the background wall).
   - Upon request, separate masks for doors and windows can also be generated.